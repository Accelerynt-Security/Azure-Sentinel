id: 88b9223c-29ff-48a9-a745-c553aa0dbae2
name: Malware Detection Session Finished
description: Detects when restore points are marked as infected with malware, indicating
  potential compromise of backup data.
severity: Informational
status: Available
requiredDataConnectors:
  - connectorId: Syslog
    dataTypes: 
      - Syslog
  - connectorId: SyslogAma
    dataTypes: 
      - Syslog
queryFrequency: 3h
queryPeriod: 3h
triggerOperator: gt
triggerThreshold: 0
tactics:
- Impact
relevantTechniques:
- T1486
query: |
  let action_results_lookup = union isfuzzy=true (datatable(JobResult:string, JobResultMessage:string)[]), (_GetWatchlist("action_results_lookup")); 
  Veeam_GetSecurityEvents
  | where instanceId == 42210
  | extend Result = extract("Result=\"([^\"]*)\"", 1, SyslogMessage)
  | extend SessionID = extract("SessionID=\"([^\"]*)\"", 1, SyslogMessage)
  | lookup kind=leftouter (action_results_lookup)
      on $left.Result == $right.JobResult
  | project
      Date = format_datetime(TimeGenerated, 'dd.MM.yyyy HH:mm'),
      DataSource = original_host,
      EventId = instanceId,
      ["Session ID"] = SessionID,
      ["StateMessage"] = JobResultMessage,
      MessageDetails = Description,
      Severity = SeverityDescription
version: 1.0.0
kind: Scheduled
customDetails:
  Date: Date
  VbrHostName: DataSource
  EventId: EventId
  MessageDetails: MessageDetails
  Severity: Severity
