{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Not used, but needed to pass the arm-ttk test, 'Location-Should-Not-Be-Hardcoded'. Instead the `workspace-location` derived from the log analytics workspace is used."
            }
        },
        "workspace-location": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
            }
        },
        "subscription": {
            "defaultValue": "[last(split(subscription().id, '/'))]",
            "type": "string",
            "metadata": {
                "description": "subscription id where Microsoft Sentinel is configured"
            }
        },
        "resourceGroupName": {
            "defaultValue": "[resourceGroup().name]",
            "type": "string",
            "metadata": {
                "description": "resource group name where Microsoft Sentinel is configured"
            }
        },
        "workspace": {
            "defaultValue": "",
            "type": "string",
            "metadata": {
                "description": "the log analytics workspace enabled for Microsoft Sentinel"
            }
        }
    },
    "variables": {
        "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
        "_solutionName": "RSA ID Plus Admin Logs Connector",
        "_solutionVersion": "3.0.0",
        "_solutionAuthor": "RSA Security",
        "_packageIcon": "logo.png",
        "_solutionId": "azuresentinel.azure-sentinel-solution-azuresentinel.azure-sentinel-RSAIDPlus-AdminLogs-Connector",
        "dataConnectorVersionConnectorDefinition": "1.0.0",
        "dataConnectorVersionConnections": "1.0.0",
        "_solutionTier": "Community",
        "_dataConnectorContentIdConnectorDefinition": "RSAIDPlus_AdmingLogs_Connector",
        "dataConnectorTemplateNameConnectorDefinition": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition')))]",
        "_dataConnectorContentIdConnections": "RSAIDPlus-AdminLogs_TemplateConnections",
        "dataConnectorTemplateNameConnections": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections')))]",
        "_logAnalyticsTableId1": "RSAIDPlus_AdminLogs_CL"
    },
    "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2025-07-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition'), variables('dataConnectorVersionConnectorDefinition'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
                "displayName": "[concat(variables('_solutionName'), variables('dataConnectorTemplateNameConnectorDefinition'))]",
                "contentKind": "DataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorVersionConnectorDefinition')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition')))]",
                            "apiVersion": "2025-07-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
                                "kind": "DataConnector",
                                "version": "[variables('dataConnectorVersionConnectorDefinition')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "[variables('_solutionAuthor')]"
                                },
                                "support": {
                                    "name": "[variables('_solutionAuthor')]",
                                    "tier": "[variables('_solutionTier')]"
                                },
                                "dependencies": {
                                    "criteria": [
                                        {
                                            "version": "[variables('dataConnectorVersionConnections')]",
                                            "contentId": "[variables('_dataConnectorContentIdConnections')]",
                                            "kind": "ResourcesDataConnector"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "apiVersion": "2025-07-01-preview",
                            "name": "RSAIDPlus_AdminLogs_DCR",
                            "location": "{{location}}",
                            "properties": {
                                "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
                                "streamDeclarations": {
                                    "Custom-RSAIDPlus_AdminLogs_CL": {
                                        "columns": [
                                            {
                                                "name": "eventId",
                                                "type": "long"
                                            },
                                            {
                                                "name": "eventLogDate",
                                                "type": "datetime"
                                            },
                                            {
                                                "name": "eventType",
                                                "type": "string"
                                            },
                                            {
                                                "name": "serverURL",
                                                "type": "string"
                                            },
                                            {
                                                "name": "serverIPAddress",
                                                "type": "string"
                                            },
                                            {
                                                "name": "application",
                                                "type": "string"
                                            },
                                            {
                                                "name": "customerId",
                                                "type": "int"
                                            },
                                            {
                                                "name": "customerName",
                                                "type": "string"
                                            },
                                            {
                                                "name": "sourceIPAddress",
                                                "type": "string"
                                            },
                                            {
                                                "name": "adminUserName",
                                                "type": "string"
                                            },
                                            {
                                                "name": "adminUserRole",
                                                "type": "string"
                                            },
                                            {
                                                "name": "activityKey",
                                                "type": "string"
                                            },
                                            {
                                                "name": "activityCode",
                                                "type": "int"
                                            },
                                            {
                                                "name": "result",
                                                "type": "string"
                                            },
                                            {
                                                "name": "reasonKey",
                                                "type": "string"
                                            },
                                            {
                                                "name": "message",
                                                "type": "string"
                                            },
                                            {
                                                "name": "requiresPublish",
                                                "type": "boolean"
                                            },
                                            {
                                                "name": "targetObject1Id",
                                                "type": "dynamic"
                                            },
                                            {
                                                "name": "targetObject1Name",
                                                "type": "dynamic"
                                            },
                                            {
                                                "name": "targetObject1Type",
                                                "type": "dynamic"
                                            },
                                            {
                                                "name": "targetObject2Id",
                                                "type": "dynamic"
                                            },
                                            {
                                                "name": "targetObject2Name",
                                                "type": "dynamic"
                                            },
                                            {
                                                "name": "targetObject2Type",
                                                "type": "dynamic"
                                            }
                                        ]
                                    }
                                },
                                "dataSources": {},
                                "destinations": {
                                    "logAnalytics": [
                                        {
                                            "workspaceResourceId": "{{workspaceResourceId}}",
                                            "name": "clv2ws1"
                                        }
                                    ]
                                },
                                "dataFlows": [
                                    {
                                        "streams": [
                                            "Custom-RSAIDPlus_AdminLogs_CL"
                                        ],
                                        "destinations": [
                                            "clv2ws1"
                                        ],
                                        "transformKql": "source\n| extend TimeGenerated = todatetime(eventLogDate)\n| project-away eventLogDate\n",
                                        "outputStream": "Custom-RSAIDPlus_AdminLogs_CL"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "[variables('_logAnalyticsTableId1')]",
                            "apiVersion": "2025-07-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/tables",
                            "properties": {
                                "schema": {
                                    "name": "RSAIDPlus_AdminLogs_CL",
                                    "description": "This table is used to store the admin audit event data.",
                                    "columns": [
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "activityCode",
                                            "type": "int"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "activityKey",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "adminUserName",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "adminUserRole",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "application",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "customerId",
                                            "type": "int"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "eventId",
                                            "type": "long"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "eventType",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "message",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "reasonKey",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "requiresPublish",
                                            "type": "boolean"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "result",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "serverIPAddress",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "serverURL",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "sourceIPAddress",
                                            "type": "string"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "targetObject1Id",
                                            "type": "dynamic"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "targetObject1Name",
                                            "type": "dynamic"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "targetObject1Type",
                                            "type": "dynamic"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "targetObject2Id",
                                            "type": "dynamic"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "targetObject2Name",
                                            "type": "dynamic"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "targetObject2Type",
                                            "type": "dynamic"
                                        },
                                        {
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "TimeGenerated",
                                            "type": "datetime"
                                        },
                                        {
                                            "description": "",
                                            "isDefaultDisplay": false,
                                            "isHidden": false,
                                            "name": "customerName",
                                            "type": "string"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition'),'-', variables('dataConnectorVersionConnectorDefinition'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('_solutionVersion')]"
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition'))]",
            "apiVersion": "2025-07-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
            "location": "[parameters('workspace-location')]",
            "kind": "Customizable",
            "properties": {
                "connectorUiConfig": {
                    "id": "RSAIDPlus_AdmingLogs_Connector",
                    "title": "RSA ID Plus Admin Logs Connector",
                    "publisher": "RSA",
                    "descriptionMarkdown": "The RSA ID Plus AdminLogs Connector provides the capability to ingest [Cloud Admin Console Audit Events](https://community.rsa.com/s/article/Cloud-Administration-Event-Log-API-5d22ba17) into Microsoft Sentinel using Cloud Admin APIs.",
                    "graphQueriesTableName": "RSAIDPlus_AdminLogs_CL",
                    "graphQueries": [
                        {
                            "metricName": "Events Received",
                            "legend": "RSA ID Plus Admin Activity Events Received",
                            "baseQuery": "{{graphQueriesTableName}}"
                        }
                    ],
                    "sampleQueries": [
                        {
                            "description": "All RSA ID Plus Admin Activity Logs",
                            "query": "{{graphQueriesTableName}}\n| sort by TimeGenerated desc"
                        },
                        {
                            "description": "Total Events",
                            "query": "{{graphQueriesTableName}}\n| summarize count() by eventId"
                        }
                    ],
                    "dataTypes": [
                        {
                            "name": "{{graphQueriesTableName}}",
                            "lastDataReceivedQuery": "{{graphQueriesTableName}}\n| summarize Time = max(TimeGenerated)\n| where isnoempty(Time)"
                        }
                    ],
                    "logo": "logo.png",
                    "connectivityCriteria": [
                        {
                            "type": "HasDataConnectors"
                        }
                    ],
                    "defaultDataCollectionConfiguration": {
                        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
                        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
                    },
                    "permissions": {
                        "resourceProvider": [
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces",
                                "permissionsDisplayText": "Read and Write permissions are required.",
                                "providerDisplayName": "Workspace",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "write": true,
                                    "read": true,
                                    "delete": true
                                }
                            }
                        ],
                        "customs": [
                            {
                                "name": "RSA ID Plus API Authentication",
                                "description": "To access the Admin APIs, a valid Base64URL encoded JWT token, signed with the client's Legacy Administration API key is required."
                            }
                        ]
                    },
                    "instructionSteps": [
                        {
                            "description": ">**NOTE:** This connector uses Codeless Connector Framework (CCF) to connect to the RSA ID Plus Cloud Admin APIs to pull logs into Microsoft Sentinel."
                        },
                        {
                            "title": "**STEP 1** - Create Legacy Admin API Client in Cloud Admin Console.",
                            "description": "Follow steps mentioned in this [page](https://community.rsa.com/s/article/Manage-Legacy-Clients-API-Keys-a89c9cbc#)."
                        },
                        {
                            "title": "**STEP 2** - Generate the Base64URL encoded JWT Token.",
                            "description": "Follow the steps mentioned in this [page](https://community.rsa.com/s/article/Authentication-for-the-Cloud-Administration-APIs-a04e3fb9) under the header 'Legacy Administration API'."
                        },
                        {
                            "title": "**STEP 3** - Configure the Cloud Admin API to start ingesting Admin event logs into Microsoft Sentinel.",
                            "description": "Provide the required values below:\n",
                            "instructions": [
                                {
                                    "type": "Textbox",
                                    "parameters": {
                                        "label": "Admin API URL",
                                        "placeholder": "https://<tenantName>.access.securid.com/AdminInterface/restapi/v1/adminlog/exportLogs",
                                        "type": "text",
                                        "name": "Admin-API-URL"
                                    }
                                },
                                {
                                    "type": "Textbox",
                                    "parameters": {
                                        "label": "JWT Token",
                                        "placeholder": "Enter your JWT Token",
                                        "type": "password",
                                        "name": "access_token"
                                    }
                                }
                            ]
                        },
                        {
                            "title": "**STEP 4** - Click Connect",
                            "description": "Verify all the fields above were filled in correctly. Press Connect to start the connector.",
                            "instructions": [
                                {
                                    "type": "ConnectionToggleButton",
                                    "parameters": {
                                        "connectLabel": "Connect",
                                        "name": "connect"
                                    }
                                }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition')))]",
            "apiVersion": "2025-07-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersionConnectorDefinition')]",
                "source": {
                    "sourceId": "[variables('_solutionId')]",
                    "name": "[variables('_solutionName')]",
                    "kind": "Solution"
                },
                "author": {
                    "name": "[variables('_solutionAuthor')]"
                },
                "support": {
                    "name": "[variables('_solutionAuthor')]",
                    "tier": "[variables('_solutionTier')]"
                },
                "dependencies": {
                    "criteria": [
                        {
                            "version": "[variables('dataConnectorVersionConnections')]",
                            "contentId": "[variables('_dataConnectorContentIdConnections')]",
                            "kind": "ResourcesDataConnector"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2025-07-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections'), variables('dataConnectorVersionConnections'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnections')]",
                "displayName": "[concat(variables('_solutionName'), variables('dataConnectorTemplateNameConnections'))]",
                "contentKind": "ResourcesDataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorVersionConnections')]",
                    "parameters": {
                        "Admin-API-URL": {
                            "defaultValue": "https://tenantName.access.securid.com/AdminInterface/restapi/v1/adminlog/exportlogs",
                            "type": "string",
                            "minLength": 1
                        },
                        "access_token": {
                            "defaultValue": "",
                            "type": "securestring"
                        },
                        "connectorDefinitionName": {
                            "defaultValue": "connectorDefinitionName",
                            "type": "string",
                            "minLength": 1
                        },
                        "workspace": {
                            "defaultValue": "[parameters('workspace')]",
                            "type": "string"
                        },
                        "dcrConfig": {
                            "defaultValue": {
                                "dataCollectionEndpoint": "data collection Endpoint",
                                "dataCollectionRuleImmutableId": "data collection rule immutableId"
                            },
                            "type": "object"
                        },
                        "_solutionId": {
                            "type": "string",
                            "defaultValue": "[variables('_solutionId')]"
                        }
                    },
                    "variables": {
                        "_dataConnectorContentIdConnections": "[variables('_dataConnectorContentIdConnections')]",
                        "_solutionId": "[variables('_solutionId')]"
                    },
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections')))]",
                            "apiVersion": "2025-07-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnections')]",
                                "kind": "ResourcesDataConnector",
                                "version": "[variables('dataConnectorVersionConnections')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "[variables('_solutionAuthor')]"
                                },
                                "support": {
                                    "name": "[variables('_solutionAuthor')]",
                                    "tier": "[variables('_solutionTier')]"
                                }
                            }
                        },
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]",
                            "apiVersion": "2025-07-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                            "location": "[parameters('workspace-location')]",
                            "kind": "RestApiPoller",
                            "properties": {
                                "connectorDefinitionName": "RSAIDPlus_AdmingLogs_Connector",
                                "dataType": "RSAIDPlus_AdminLogs_CL",
                                "dcrConfig": {
                                    "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
                                    "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}",
                                    "streamName": "Custom-RSAIDPlus_AdminLogs_CL"
                                },
                                "auth": {
                                    "type": "APIKey",
                                    "ApiKey": "[[parameters('access_token')]",
                                    "ApiKeyName": "X-API-Key"
                                },
                                "request": {
                                    "apiEndpoint": "https://[[parameters('Admin-API-URL')]",
                                    "httpMethod": "GET",
                                    "headers": {
                                        "Accept": "application/json"
                                    },
                                    "retryCount": 3,
                                    "timeoutInSeconds": 60,
                                    "queryWindowInMin": 5,
                                    "StartTimeAttributeName": "startTimeAfter",
                                    "EndTimeAttributeName": "endTimeOnOrBefore"
                                },
                                "response": {
                                    "eventsJsonPaths": [
                                        "$.elements"
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections'),'-', variables('dataConnectorVersionConnections'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('_solutionVersion')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]",
            "location": "[parameters('workspace-location')]",
            "apiVersion": "2025-07-01-preview",
            "properties": {
                "version": "[variables('_solutionVersion')]",
                "kind": "Solution",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_solutionId')]",
                "source": {
                    "kind": "Solution",
                    "name": "[variables('_solutionName')]",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "[variables('_solutionAuthor')]"
                },
                "support": {
                    "name": "[variables('_solutionAuthor')]"
                },
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "kind": "DataConnector",
                            "contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
                            "version": "[variables('dataConnectorVersionConnectorDefinition')]"
                        }
                    ]
                },
                "firstPublishDate": "2023-12-05",
                "providers": [
                    "[variables('_solutionAuthor')]"
                ],
                "contentKind": "Solution",
                "packageId": "[variables('_solutionId')]",
                "contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]",
                "displayName": "[variables('_solutionName')]",
                "publisherDisplayName": "[variables('_solutionId')]",
                "descriptionHtml": "test",
                "icon": "[variables('_packageIcon')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2025-07-01-preview",
            "name": "[concat(parameters('workspace'), '/Microsoft.SecurityInsights/', 'RSAIDPlus_LockedAdminAccount_AnalyticRule')]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "contentId": "RSAIDPlus_LockedAdminAccount_AnalyticRule",
                "displayName": "RSA ID Plus - Locked Administrator Account Detected",
                "contentKind": "AnalyticsRule",
                "descriptionMarkdown": "Detects events where an RSA ID Plus administrator account has been locked. This may indicate multiple failed login attempts or account compromise.\n\n### Suggested Automation\nTo send an email alert when this rule triggers:\n1. Go to **Microsoft Sentinel \u2192 Automation \u2192 Create automation rule**.\n2. Set trigger: `When alert from this analytic rule fires`.\n3. Add an action \u2192 **Run playbook** \u2192 select **SendEmailOnRSAIDPlusAlert**.\n4. Customize recipients in the playbook if needed.",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/alertRules",
                            "apiVersion": "2025-07-01-preview",
                            "name": "RSAIDPlus_LockedAdminAccount_Rule",
                            "properties": {
                                "displayName": "RSA ID Plus - Locked Administrator Account Detected",
                                "enabled": true,
                                "severity": "High",
                                "tactics": [
                                    "CredentialAccess"
                                ],
                                "techniques": [
                                    "T1110"
                                ],
                                "query": "RSAIDPlus_AdminLogs_CL\n| where activityKey == 'LOCKED_ADMIN_ACCOUNT'\n| project TimeGenerated, customerName, adminUserName, adminUserRole, activityKey, sourceIPAddress",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "customDetails": {
                                    "Customer_Name": "customerName",
                                    "Administrator": "adminUserName",
                                    "Administrator_Type": "adminUserRole",
                                    "Activity": "activityKey"
                                },
                                "entityMappings": [
                                    {
                                        "entityType": "IP",
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "sourceIPAddress"
                                            }
                                        ]
                                    },
                                    {
                                        "entityType": "Account",
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "adminUserName"
                                            }
                                        ]
                                    },
                                    {
                                        "entityType": "Host",
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "customerName"
                                            }
                                        ]
                                    }
                                ],
                                "alertDetailsOverride": {
                                    "alertDisplayNameFormat": "RSA ID Plus - Locked Administrator Account Detected: {{adminUserName}}",
                                    "alertDescriptionFormat": "Administrator {{adminUserName}} ({{adminUserRole}}) was locked in tenant {{customerName}}. Source IP: {{sourceIPAddress}}"
                                },
                                "incidentConfiguration": {
                                    "createIncident": true
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2025-07-01-preview",
            "name": "[concat(parameters('workspace'), '/Microsoft.SecurityInsights/', 'RSAIDPlus_SendEmail_Playbook')]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "contentId": "RSAIDPlus_SendEmail_Playbook",
                "displayName": "Send Email on RSA ID Plus Alert",
                "contentKind": "Playbook",
                "description": "Sends an email notification when an RSA ID Plus analytic rule triggers. This playbook can be linked via automation rules.",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": [
                        {
                            "type": "Microsoft.Logic/workflows",
                            "apiVersion": "2025-07-01-preview",
                            "name": "SendEmailOnRSAIDPlusAlert",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "state": "Enabled",
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "triggers": {
                                        "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                                            "type": "Request",
                                            "kind": "Http",
                                            "inputs": {
                                                "schema": {
                                                    "type": "object",
                                                    "properties": {
                                                        "IncidentName": {
                                                            "type": "string"
                                                        },
                                                        "Severity": {
                                                            "type": "string"
                                                        },
                                                        "Description": {
                                                            "type": "string"
                                                        },
                                                        "AlertLink": {
                                                            "type": "string"
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    },
                                    "actions": {
                                        "Send_email": {
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['office365']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/v2/Mail",
                                                "body": {
                                                    "Message": {
                                                        "Subject": "@concat('Sentinel Alert: ', triggerBody()?['IncidentName'])",
                                                        "Body": "@concat('<p><b>Alert:</b> ', triggerBody()?['IncidentName'], '</p><p><b>Severity:</b> ', triggerBody()?['Severity'], '</p><p><b>Description:</b> ', triggerBody()?['Description'], '</p><p><b>Alert Link:</b> <a href=\"', triggerBody()?['AlertLink'], '\">View in Sentinel</a></p>')",
                                                        "ToRecipients": [
                                                            {
                                                                "EmailAddress": {
                                                                    "Address": "securityteam@company.com"
                                                                }
                                                            }
                                                        ]
                                                    },
                                                    "SaveToSentItems": "false"
                                                }
                                            },
                                            "runAfter": {}
                                        }
                                    },
                                    "outputs": {}
                                },
                                "parameters": {
                                    "$connections": {
                                        "value": {
                                            "office365": {
                                                "connectionId": "/subscriptions/<yourSubId>/providers/Microsoft.Web/connections/office365",
                                                "connectionName": "office365",
                                                "id": "/subscriptions/<yourSubId>/providers/Microsoft.Web/locations/<region>/managedApis/office365"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        }
    ]
}