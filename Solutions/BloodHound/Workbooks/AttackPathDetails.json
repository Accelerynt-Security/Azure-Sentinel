{
    "version": "Notebook/1.0",
    "items": [
      {
        "type": 9,
        "content": {
          "version": "KqlParameterItem/1.0",
          "parameters": [
            {
              "id": "f0dfd85a-6c9c-4dab-91d7-d67cb23b1fb2",
              "version": "KqlParameterItem/1.0",
              "name": "bhe_tenant",
              "label": "BHE Tenant",
              "type": 2,
              "isRequired": true,
              "multiSelect": true,
              "quote": "'",
              "delimiter": ",",
              "query": "BloodHoundAttackPathsDetails_CL\n| where isnotempty(tenant_url)\n| summarize arg_max(TimeGenerated, *) by tenant_url\n| extend display_name = replace_string(tenant_url, @\"https://\", \"\")\n| extend display_name = replace_string(display_name, @\"http://\", \"\")\n| extend display_name = replace_string(display_name, @\"/\", \"\") \n| project tenant_url, display_name",
              "typeSettings": {
                "additionalResourceOptions": [
                  "value::all"
                ],
                "showDefault": false
              },
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "value": [
                "value::all"
              ]
            },
            {
              "id": "390213b5-e0d3-476c-99ca-89c76f417e7a",
              "version": "KqlParameterItem/1.0",
              "name": "domain_name",
              "label": "Domain",
              "type": 2,
              "isRequired": true,
              "multiSelect": true,
              "quote": "'",
              "delimiter": ",",
              "query": "BloodHoundAttackPathsDetails_CL\n| where isnotempty(domain_name)\n| where tenant_url in~ ({bhe_tenant})\n| distinct domain_name",
              "typeSettings": {
                "additionalResourceOptions": [
                  "value::all"
                ],
                "showDefault": false
              },
              "timeContext": {
                "durationMs": 86400000
              },
              "defaultValue": "value::all",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            {
              "id": "d6d95707-5b3e-4757-97e4-d53b956b5804",
              "version": "KqlParameterItem/1.0",
              "name": "finding_type",
              "label": "Attack Path",
              "type": 2,
              "isRequired": true,
              "query": "BloodHoundAttackPathsDetails_CL \n| where isnotempty(PathTitle)\n| where tenant_url in~ ({bhe_tenant})\n| where domain_name in~ ({domain_name})\n| distinct PathTitle",
              "typeSettings": {
                "additionalResourceOptions": [
                  "value::1"
                ],
                "showDefault": false
              },
              "timeContext": {
                "durationMs": 86400000
              },
              "defaultValue": "value::1",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            }
          ],
          "style": "pills",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces"
        },
        "name": "parameters - 3"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "BloodHoundAttackPathsDetails_CL\n| where tenant_url in~ ({bhe_tenant})\n| summarize arg_max(updated_at, *) by DomainSID, domain_name,  PathTitle| sort by round(ExposurePercentage) desc| project     ['Domain'] = domain_name,    ['Attack path'] = PathTitle,    Severity,    ['ExposurePercentage (%)'] = round(ExposurePercentage, 2)",
          "size": 0,
          "title": "Attack Path Details",
          "timeContext": {
            "durationMs": 86400000
          },
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "rowLimit": 10000
          }
        },
        "name": "query - 4"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "BloodHoundAttackPathsDetails_CL\n| where tenant_url in~ ({bhe_tenant})\n| where domain_name in~ ({domain_name})\n| summarize arg_max(TimeGenerated, *) by id, domain_name\n| extend \n    NonTierZeroPrincipalDistinguishedName = tostring(parse_json(NonTierZeroPrincipalProps).distinguishedname),\n    NonTierZeroPrincipalSAMAccountName = tostring(parse_json(NonTierZeroPrincipalProps).samaccountname),\n    NonTierZeroPrincipalLastLogon = todatetime(unixtime_seconds_todatetime(tolong(parse_json(NonTierZeroPrincipalProps).lastlogon))),\n    NonTierZeroPrincipalLastLogonTimestamp = todatetime(unixtime_seconds_todatetime(tolong(parse_json(NonTierZeroPrincipalProps).lastlogontimestamp))),\n    NonTierZeroPrincipalCreated = todatetime(unixtime_seconds_todatetime(tolong(parse_json(NonTierZeroPrincipalProps).whencreated))),\n    IsTierZero = case(\n        tostring(parse_json(ImpactedPrincipalProps).system_tags) contains \"admin_tier_0\", true,\n        false\n    )\n| project \n    [\"Non Tier Zero Principal\"] = NonTierZeroPrincipalName,\n    [\"Impacted Principal\"] = ImpactedPrincipalName,\n    [\"Path Title\"] = PathTitle,\n    [\"Distinguished Name\"] = NonTierZeroPrincipalDistinguishedName,\n    [\"Severity Level\"] = Severity,\n    [\"Impact %\"] = todouble(ImpactPercentage),\n    [\"Impact Count\"] = toint(ImpactCount),\n    [\"Exposure %\"] = todouble(ExposurePercentage),\n    [\"Exposure Count\"] = toint(ExposureCount),\n    [\"SAM Account Name\"] = NonTierZeroPrincipalSAMAccountName,\n    [\"Sensitive\"] = IsTierZero,\n    [\"Last Logon\"] = NonTierZeroPrincipalLastLogon,\n    [\"Last Logon Timestamp\"] = NonTierZeroPrincipalLastLogonTimestamp,\n    [\"Created Timestamp\"] = NonTierZeroPrincipalCreated,\n    [\"First Seen\"] = todatetime(created_at),\n    [\"Last Updated\"] = todatetime(updated_at),\n    Finding = Finding,\n    DomainName = domain_name,\n    Environment = Environment\n| order by [\"Last Updated\"] desc\n\n\n\n\n\n",
          "size": 1,
          "title": "Principals",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "rowLimit": 10000,
            "filter": true
          }
        },
        "name": "query - 2"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "BloodHoundAttackPathsTimelineData_CL\n| where isnotempty(domain_name)\n| where tenant_url in~ ({bhe_tenant})\n| where domain_name in~ ({domain_name})\n| summarize arg_max(TimeGenerated, *) by id, domain_name, tenant_url\n| extend event_day = format_datetime(todatetime(updated_at), 'yyyy-MM-dd')\n| summarize arg_max(updated_at, *) by event_day, domain_name\n| extend _time = todatetime(event_day)\n| extend ExposureCount = round(todouble(ExposureCount), 4)\n| summarize LatestCompositeRisk = max(ExposureCount) by bin(_time, 2d)\n| order by _time asc",
          "size": 0,
          "title": "Maximum Exposure Percentage",
          "timeContext": {
            "durationMs": 172800000
          },
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "timechart"
        },
        "name": "query - 4"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "BloodHoundAttackPathsTimelineData_CL\n| where tenant_url in~ ({bhe_tenant})\n| where domain_name in~ ({domain_name})\n| extend _time = todatetime(updated_at)\n| where isnotnull(_time)\n| summarize arg_max(TimeGenerated,*) by id, domain_name, tenant_url\n| summarize SumFindingCount = sum(toint(FindingCount)) by bin(_time, 1d)\n| order by _time asc",
          "size": 0,
          "timeContext": {
            "durationMs": 172800000
          },
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "timechart"
        },
        "name": "query - 6"
      }
    ],
    "fallbackResourceIds": [
      "/subscriptions/8487150a-2b54-4945-9a15-7aae2d005a3d/resourcegroups/specterops/providers/microsoft.operationalinsights/workspaces/specterops-log-analytics-workspace"
    ],
    "fromTemplateId": "sentinel-UserWorkbook",
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
  }
