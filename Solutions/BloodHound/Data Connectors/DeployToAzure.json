{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass the arm-ttk test, 'Location-Should-Not-Be-Hardcoded'. Instead the `workspace-location` derived from the log analytics workspace is used."
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "Central India",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "subscription": {
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "type": "string",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is configured"
      }
    },
    "resourceGroupName": {
      "defaultValue": "[resourceGroup().name]",
      "type": "string",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is configured"
      }
    },
    "workspace": {
      "defaultValue": "BloodHound-Log-Analytics",
      "type": "string",
      "metadata": {
        "description": "the log analytics workspace enabled for Microsoft Sentinel"
      }
    },
    "workspaceId": {
      "type": "string",
      "metadata": {
        "description": "The unique identifier (GUID) of the Log Analytics workspace."
      }
    }
  },
  "variables": {
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_logAnalyticsTableId1": "BHEAttackPathsData_CL",
    "_logAnalyticsTableId2": "BHEAttackPathsTimelineData_CL",
    "_logAnalyticsTableId3": "BHEAuditLogsData_CL",
    "dceResourceName": "BloodHoundDCE",
    "dceImmutableId": "[guid(variables('dceResourceName'))]",
    "dcrResourceName": "BloodHoundDCR"
  },
  "resources": [
    {
      "name": "[variables('dceResourceName')]",
      "type": "Microsoft.Insights/dataCollectionEndpoints",
      "apiVersion": "2021-09-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "DCE for fetching Attack Paths from BloodHound Enterprise",
        "networkAcls": {
          "publicNetworkAccess": "Enabled"
        },
        "configurationAccess": {
          "immutableId": "[variables('dceImmutableId')]"
        }
      }
    },
    // --- Custom Log Table 1 (BHEAttackPathsData_CL) ---
    {
      "name": "[concat(parameters('workspace'), '/', variables('_logAnalyticsTableId1'))]",
      "apiVersion": "2022-10-01",
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "location": "[parameters('workspace-location')]",
      "kind": null,
      "properties": {
        "totalRetentionInDays": 30,
        "archiveRetentionInDays": 0,
        "plan": "Analytics",
        "retentionInDaysAsDefault": true,
        "totalRetentionInDaysAsDefault": true,
        "schema": {
          "tableSubType": "DataCollectionRuleBased",
          "name": "[variables('_logAnalyticsTableId1')]",
          "tableType": "CustomLog",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipal",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipal",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "domain_name",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipalProps",
              "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipalKind",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipalProps",
              "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipalKind",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "RelProps",
              "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ComboGraphRelationID",
              "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "Finding",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "DomainSID",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "PrincipalHash",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactPercentage",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactCount",
              "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ExposurePercentage",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ExposureCount",
              "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "Severity",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "AcceptedUntil",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "Accepted",
              "type": "boolean",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "Environment",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipalName",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipalName",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "IsInherited",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipalEnvironment",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipalEnvironmentID",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipalEnvironment",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipalEnvironmentID",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "id",
              "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "created_at",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "updated_at",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "deleted_at",
              "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "tenant_url",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "Remediation",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "PathTitle",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ShortDescription",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ShortRemediation",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "LongRemediation",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "standardColumns": [
            {
              "name": "TenantId",
              "type": "guid",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "solutions": [
            "LogManagement"
          ],
          "isTroubleshootingAllowed": true
        },
        "provisioningState": "Succeeded",
        "retentionInDays": 30
      },
      "id": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspace'), '/tables/', variables('_logAnalyticsTableId1'))]"
    },
    // --- Custom Log Table 2 (BHEAttackPathsTimelineData_CL) ---
    {
      "name": "[concat(parameters('workspace'), '/', variables('_logAnalyticsTableId2'))]",
      "apiVersion": "2022-10-01",
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "location": "[parameters('workspace-location')]",
      "kind": null,
      "properties": {
        "totalRetentionInDays": 30,
        "archiveRetentionInDays": 0,
        "plan": "Analytics",
        "retentionInDaysAsDefault": true,
        "totalRetentionInDaysAsDefault": true,
        "schema": {
          "tableSubType": "DataCollectionRuleBased",
          "name": "[variables('_logAnalyticsTableId2')]",
          "tableType": "CustomLog",
          "columns": [
            {
                        "name": "CompositeRisk",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "domain_name",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "tenant_url",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "FindingCount",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "ExposureCount",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "ImpactCount",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "ImpactedAssetCount",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "DomainSID",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "Finding",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "id",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "path_title",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "created_at",
                        "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "updated_at",
                        "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "deleted_at",
                        "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "TimeGenerated",
              "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
                    }
          ],
          "standardColumns": [
            {
              "name": "TenantId",
              "type": "guid",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "solutions": [
            "LogManagement"
          ],
          "isTroubleshootingAllowed": true
        },
        "provisioningState": "Succeeded",
        "retentionInDays": 30
      },
      "id": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspace'), '/tables/', variables('_logAnalyticsTableId2'))]"
    },
    // --- Custom Log Table 3 (BHEAuditLogsData_CL) ---
    {
      "name": "[concat(parameters('workspace'), '/', variables('_logAnalyticsTableId3'))]",
      "apiVersion": "2022-10-01",
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "location": "[parameters('workspace-location')]",
      "kind": null,
      "properties": {
        "totalRetentionInDays": 30,
        "archiveRetentionInDays": 0,
        "plan": "Analytics",
        "retentionInDaysAsDefault": true,
        "totalRetentionInDaysAsDefault": true,
        "schema": {
          "tableSubType": "DataCollectionRuleBased",
          "name": "[variables('_logAnalyticsTableId3')]",
          "tableType": "CustomLog",
          "columns": [
            {
                        "name": "id",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "created_at",
                        "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "actor_id",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "actor_name",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "actor_email",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "action",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "fields",
                        "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "request_id",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "source_ip_address",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "status",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "commit_id",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "tenant_url",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "TimeGenerated",
              "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
                    }
          ],
          "standardColumns": [
            {
              "name": "TenantId",
              "type": "guid",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "solutions": [
            "LogManagement"
          ],
          "isTroubleshootingAllowed": true
        },
        "provisioningState": "Succeeded",
        "retentionInDays": 30
      },
      "id": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspace'), '/tables/', variables('_logAnalyticsTableId3'))]"
    },
    // --- Data Collection Rule (DCR) ---
    {
      "name": "[variables('dcrResourceName')]",
      "apiVersion": "2021-09-01-preview",
      "type": "Microsoft.Insights/dataCollectionRules",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceResourceName'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('_logAnalyticsTableId1'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('_logAnalyticsTableId2'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('_logAnalyticsTableId3'))]"
      ],
      "kind": null,
      "properties": {
        "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceResourceName'))]",
        "streamDeclarations": {
          // Stream for BHEAttackPathsData_CL
          "Custom-BHEAttackPathsData_CL": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              }
            ]
          },
          // Stream for BHEAttackPathsTimelineData_CL
          "Custom-BHEAttackPathsTimelineData_CL": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              }
            ]
          },
          // Stream for BHEAuditLogsData_CL
          "Custom-BHEAuditLogsData_CL": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              }
            ]
          }
        },
        "dataSources": {},
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "workspaceId": "[parameters('workspaceId')]",
              "name": "[parameters('workspaceId')]"
            }
          ]
        },
        "dataFlows": [
          // Data flow for BHEAttackPathsData_CL
          {
            "streams": [
              "Custom-BHEAttackPathsData_CL"
            ],
            "destinations": [
              "[parameters('workspaceId')]"
            ],
            "transformKql": "source | extend TimeGenerated = now()",
            "outputStream": "Custom-BHEAttackPathsData_CL"
          },
          // Data flow for BHEAttackPathsTimelineData_CL
          {
            "streams": [
              "Custom-BHEAttackPathsTimelineData_CL"
            ],
            "destinations": [
              "[parameters('workspaceId')]"
            ],
            "transformKql": "source | extend TimeGenerated = now()",
            "outputStream": "Custom-BHEAttackPathsTimelineData_CL"
          },
          // Data flow for BHEAuditLogsData_CL
          {
            "streams": [
              "Custom-BHEAuditLogsData_CL"
            ],
            "destinations": [
              "[parameters('workspaceId')]"
            ],
            "transformKql": "source | extend TimeGenerated = now()",
            "outputStream": "Custom-BHEAuditLogsData_CL"
          }
        ],
        "provisioningState": "Succeeded"
      }
    }
  ]
}
