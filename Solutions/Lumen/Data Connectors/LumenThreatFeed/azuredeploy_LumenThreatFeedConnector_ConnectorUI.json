{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "WorkspaceName": {
  "type": "String"
    }
  },
  "resources": [
    {
  "name": "[parameters('WorkspaceName')]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces",
      "location": "[resourceGroup().location]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "id": "LumenThreatIntelligenceConnector",
          "title": "Lumen Threat Feed Data Connector",
          "publisher": "Lumen Technologies",
          "descriptionMarkdown": "The [Lumen Threat Feed](https://bll-analytics.mss.lumen.com/analytics) connector provides the capability to ingest STIX-formatted threat intelligence indicators from Lumen's Black Lotus Labs research team into Microsoft Sentinel. The connector automatically downloads and uploads daily threat intelligence indicators including IPv4 addresses and domains to the ThreatIntelIndicators table via the STIX Objects Upload API.",
          "additionalRequirementBanner": "This connector requires API access to Lumen Reputation API service, Microsoft Sentinel STIX Objects API permissions, and proper configuration of Azure AD authentication components.",
          "graphQueries": [
            {
              "metricName": "Total Threat Intelligence Indicators",
              "legend": "ThreatIntelIndicators",
              "baseQuery": "ThreatIntelIndicators | where SourceSystem == 'Lumen'"
            }
          ],
          "sampleQueries": [
            {
              "description": "All Lumen Threat Intelligence Indicators",
              "query": "ThreatIntelIndicators | where SourceSystem == 'Lumen' | sort by TimeGenerated desc"
            },
            {
              "description": "High Confidence Indicators",
              "query": "ThreatIntelIndicators | where SourceSystem == 'Lumen' and Confidence >= 80 | sort by TimeGenerated desc"
            },
            {
              "description": "Malicious IP Indicators",
              "query": "ThreatIntelIndicators | where SourceSystem == 'Lumen' and ObservableValue != '' and ObservableKey == 'ipv4-addr:value' | sort by TimeGenerated desc"
            },
            {
              "description": "Malicious Domain Indicators",
              "query": "ThreatIntelIndicators | where SourceSystem == 'Lumen' and ObservableValue != '' and ObservableKey == 'domain-name:value' | sort by TimeGenerated desc"
            },
            {
              "description": "Recent Indicators (Last 7 Days)",
              "query": "ThreatIntelIndicators | where SourceSystem == 'Lumen' and TimeGenerated > ago(7d) | summarize count() by bin(TimeGenerated, 1d)"
            }
          ],
          "dataTypes": [
            {
              "name": "ThreatIntelIndicators (Lumen)",
              "lastDataReceivedQuery": "ThreatIntelIndicators | where SourceSystem == 'Lumen' | summarize Time = max(TimeGenerated) | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "ThreatIntelIndicators | where SourceSystem == 'Lumen' | summarize LastLogReceived = max(TimeGenerated) | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
            {
                "provider": "Microsoft.SecurityInsights/threatintelligence/write",
                "permissionsDisplayText": "write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                    "write": true,
                    "read": true,
                    "delete": true
                }
            },{
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                    "write": true,
                    "read": true,
                    "delete": true
                }
            }
        ],"customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "Azure AD App Registration",
                "description": "An Azure AD application registration with ThreatIndicators.ReadWrite.OwnedBy permissions is required for STIX Objects API access. [See the documentation to learn more about Azure AD applications](https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app)."
              },
              {
                "name": "Microsoft Sentinel Contributor Role",
                "description": "Microsoft Sentinel Contributor role is required for the Azure AD application to upload threat intelligence indicators."
              },
              {
                "name": "Lumen Reputation API Key",
                "description": "A Lumen Reputation API Key is required for accessing threat intelligence data. [Contact Lumen for API access](mailto:lumen_defender_threat_feed_support@lumen.com?subject=API%20Access%20Request)."
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "",
              "description": ">**NOTE:** This connector uses Azure Functions with Durable Functions to connect to Lumen Reputation API and upload threat intelligence indicators to Microsoft Sentinel via the STIX Objects API. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "title": "Configuration",
              "description": "**STEP 1 - Configure the Lumen Reputation API**\n\n1. Contact Lumen to obtain API access to the Reputation API service\n2. Obtain your API key for authentication\n3. Verify connectivity to Lumen's threat intelligence endpoints"
            },
            {
              "title": "",
              "description": "**STEP 2 - Configure Azure AD Application**\n\n1. Create an Azure AD App Registration following [these instructions](https://learn.microsoft.com/en-us/azure/sentinel/connect-threat-intelligence-upload-api#instructions)\n2. Create a client secret and note the Application ID, Tenant ID, and Client Secret\n4. Assign the **Microsoft Sentinel Contributor** role to the application on your Sentinel Log Analytics Workspace",
              "instructions":[
                {
                    "parameters": {
                        "fillWith": [
                            "WorkspaceId"
                        ],
                        "label": "Workspace ID"
                    },
                    "type": "CopyableLabel"
                }
            ]
            },
            {
              "title": "",
              "description": "**STEP 3 - Enable the TIP data connector in Microsoft Sentinel**\n\n1. Deploy the **Threat Intelligence (New) Solution**, which includes the **Threat Intelligence Upload Indicators API (Preview)**\n2. Browse to the Content Hub, find and select the **Threat Intelligence (NEW)** solution.\n3. Select the **Install/Update** button."
            },
            {
              "title": "",
              "description": "**STEP 4 - Deploy the Azure Function**\n\n1. Click the Deploy to Azure button.\n\n[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Flumen-mcollier%2FAzure-Sentinel%2Fmaster%2FSolutions%2FLumen%2FData%2520Connectors%2FLumenThreatFeed%2Fazuredeploy_Connector_LumenThreatFeed_AzureFunction.json)\n\n2. Fill in the appropriate values for each parameter.\n\n**IMPORTANT:** Before deploying the Lumen Threat Feed connector, have the Workspace ID, Azure AD application details (Client ID, Tenant ID, Client Secret), and Lumen API key readily available."
            },
            {
              "title": "",
              "description": "**STEP 5 - Verify Deployment**\n\n1. The connector runs on a daily schedule (8:00 AM UTC by default)\n2. Monitor the Function App logs in Azure Portal to verify successful execution\n3. Check the ThreatIntelIndicators table in Microsoft Sentinel for new Lumen indicators"
            }
          ]
        }
      }
    }
  ]
}
