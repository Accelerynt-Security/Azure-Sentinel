[
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2023-02-01",
    "name": "{{innerWorkspace}}/Microsoft.SecurityInsights/PaloAltoXpanseAlertsPolling_{{domainname}}",
    "location": "{{location}}",
    "kind": "RestApiPoller",
    "properties": {
      "connectorDefinitionName": "PaloAltoExpanseCCPDefinition",
      "dataType": "CortexXpanseAlerts_CL",
      "addOnAttributes": {
        "DomainName": "[[parameters('domainName')]"
      },
      "auth": {
        "type": "APIKey",
        "ApiKey": "[[parameters('apiKey')]",
        "ApiKeyName": "Authorization"
      },
      "request": {
        "apiEndpoint": "[[concat('https://api-', parameters('domainName'), '/public_api/v2/alerts/get_alerts_multi_events')]",
        "headers": {
          "Accept": "application/json",
          "Content-Type": "application/json",
          "Authorization": "[[parameters('apiKey')]",
          "x-xdr-auth-id": "[[parameters('xpanseAuthId')]"
        },
        "httpMethod": "Post",
        "queryParametersTemplate": "{ 'request_data': { 'use_page_token': true, 'filters': [ { 'field': 'creation_time', 'operator': 'gte', 'value': {_QueryWindowStartTime} }, { 'field': 'creation_time', 'operator': 'lte', 'value': {_QueryWindowEndTime} } ], 'sort': { 'field': 'creation_time', 'keyword': 'desc' } } }",
        "queryTimeFormat": "UnixTimestampInMills",
        "queryWindowInMin": 10
      },
      "response": {
        "eventsJsonPaths": [
          "$.reply.alerts"
        ]
      },
      "dcrConfig": {
        "streamName": "Custom-CortexXpanseStreamAlerts",
        "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
        "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
      },    
      "paging": {
        "pagingType": "NextPageToken",
        "NextPageTokenJsonPath": "$.reply.next_page_token",
        "NextPageParaName": "$.request_data.next_page_token"
      }
    }
  }
]