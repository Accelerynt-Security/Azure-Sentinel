{
    "name": "SAPETDInvestigations",
    "apiVersion": "2022-09-01-preview",
    "type": "Microsoft.SecurityInsights/dataConnectorDefinitions",
    "location": "{{location}}",
    "kind": "Customizable",
    "properties": {
      "connectorUiConfig": {
        "id": "SAPETDInvestigations",
        "title": "SAP Enterprise Threat Detection - Investigations",
        "logo": "SapLogo.svg",
        "publisher": "SAP",
        "descriptionMarkdown": "The SAP Enterprise Threat Detection (ETD) Investigations data connector enables ingestion of investigation data from ETD cloud edition into Microsoft Sentinel, providing comprehensive investigation tracking, correlation, and threat hunting capabilities.",
        "graphQueriesTableName": "SAPETDInvestigations_CL",
        "graphQueries": [
          {
            "metricName": "Total investigations received",
            "legend": "ETD Investigations",
            "baseQuery": "{{graphQueriesTableName}}"
          }
        ],
        "sampleQueries": [
          {
            "description": "Get Sample of ETD Investigations",
            "query": "{{graphQueriesTableName}}\n | take 10"
          },
          {
            "description": "Get High Severity Completed Investigations",
            "query": "{{graphQueriesTableName}}\n | where Severity == \"VERY_HIGH\" and Status == \"COMPLETED\"\n | order by CompletionTimestamp desc"
          },
          {
            "description": "Investigation Activity Over Time", 
            "query": "{{graphQueriesTableName}}\n | summarize count() by bin(CompletionTimestamp, 1d)\n | render timechart"
          }
        ],
        "dataTypes": [
          {
            "name": "{{graphQueriesTableName}}",
            "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
          }
        ],
        "connectivityCriteria": [
          {
            "type": "HasDataConnectors"
          }
        ],
        "availability": {
          "isPreview": true
        },
        "permissions": {
          "resourceProvider": [
            {
              "provider": "Microsoft.OperationalInsights/workspaces",
              "permissionsDisplayText": "Read and Write permissions are required.",
              "providerDisplayName": "Workspace",
              "scope": "Workspace",
              "requiredPermissions": {
                "write": true,
                "read": true,
                "delete": true
              }
            },
            {
              "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
              "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
              "providerDisplayName": "Keys",
              "scope": "Workspace",
              "requiredPermissions": {
                "action": true
              }
            }
          ],
          "customs": [
            {
              "name": "Client Id and Client Secret for ETD Investigations API",
              "description": "Enable API access to ETD Investigations endpoint."
            }
          ]
        },
        "instructionSteps": [
          {
            "description": "**Step 1 - Configuration steps for the SAP ETD Investigations API**\n\nFollow the steps provided by SAP [see ETD docs](https://help.sap.com/docs/ETD/sap-business-technology-platform/audit-log-retrieval-api-for-global-accounts-in-cloud-foundry-environment/) to enable API access for investigations. Take a note of the **url** (ETD API URL), **uaa.url** (User Account and Authentication Server url) and the associated **uaa.clientid**.\n\n>**NOTE:** You can onboard one or more ETD subaccounts by following the steps provided by SAP [see ETD docs](https://help.sap.com/docs/ETD/sap-business-technology-platform/audit-log-retrieval-api-usage-for-subaccounts-in-cloud-foundry-environment/). Add a connection for each subaccount.\n\n>**TIP:** Use the [shared blog series](https://community.sap.com/t5/enterprise-resource-planning-blog-posts-by-sap/sap-enterprise-threat-detection-cloud-edition-joins-forces-with-microsoft/ba-p/13942075) for additional info."
          },
          {
            "description": "Connect using OAuth client credentials for Investigations API",
            "title": "Connect investigation data from SAP ETD to Microsoft Sentinel",
            "instructions": [
              {
                "type": "ContextPane",
                "parameters": {
                  "contextPaneType": "DataConnectorsContextPane",
                  "label": "Add account",
                  "isPrimary": true,
                  "title": "ETD Investigations connection",
                  "instructionSteps": [
                    {
                      "title": "Account Details",
                      "instructions": [
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "SAP ETD Client ID",
                            "placeholder": "Client ID",
                            "type": "text",
                            "name": "clientId"
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "SAP ETD Client Secret",
                            "placeholder": "Client Secret",
                            "type": "password",
                            "name": "clientSecret"
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Authorization server URL (UAA server)",
                            "placeholder": "https://your-tenant.authentication.region.hana.ondemand.com/oauth/token",
                            "type": "text",
                            "name": "authServerUrl"
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "SAP ETD data retrieval API URL",
                            "placeholder": "https://your-etd-cloud-data-retrieval-service.cfapps.region.hana.ondemand.com",
                            "type": "text",
                            "name": "etdHost"
                          }
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          },
          {
            "title": "ETD accounts",
            "description": "Each row represents a connected ETD account for investigations data",
            "instructions": [
              {
                "type": "DataConnectorsGrid",
                "parameters": {
                  "mapping": [
                    {
                      "columnName": "Investigations API endpoint",
                      "columnValue": "properties.request.apiEndpoint"
                    }
                  ],
                  "menuItems": [
                    "DeleteConnector"
                  ]
                }
              }
            ]
          }
        ]
      }
    }
}