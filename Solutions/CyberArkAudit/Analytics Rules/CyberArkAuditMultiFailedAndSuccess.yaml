kind: Scheduled
name: CyberArk - Multiple Failed Actions Followed by Success (15m)
description: >
  Detects 3+ failed actions against an account followed by a success in a short window,
  indicating brute-force or credential guessing.
severity: High
tactics:
  - CredentialAccess
queryFrequency: PT5M
queryPeriod: PT15M
triggerOperator: GreaterThan
triggerThreshold: 0
query: |
  let window = 15m;
  let fails =
      CyberArk_AuditEvents_CL
      | extend EventTime = datetime(1970-01-01) + tolong(timestamp)*1s
      | where EventTime > ago(window)
      | where actionType has_any ("Fail","Failed","Denied","Error")
          or message has_any ("fail","failed","denied","unauthorized")
      | summarize Fails=count(), firstFail=min(EventTime), lastFail=max(EventTime) by username, targetAccount;
  let success =
      CyberArk_AuditEvents_CL
      | extend EventTime = datetime(1970-01-01) + tolong(timestamp)*1s
      | where EventTime > ago(window)
      | where actionType has_any ("Success","Succeeded","Allow","Allowed")
          or message has_any ("success","allowed")
      | summarize Successes=count(), firstSuccess=min(EventTime) by username, targetAccount;
  fails
  | where Fails >= 3
  | join kind=inner success on username, targetAccount
  | project username, targetAccount, Fails, Successes, firstFail, lastFail, firstSuccess
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: username
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: targetAccount
suppressionEnabled: false
version: 1.0.0
