kind: Scheduled
name: CyberArk - Mass Actions by Same User (10m Spike)
description: >
  Detects high-volume operations by a single user in a short period (possible scripted
  abuse or bulk changes). Default threshold: >= 50 actions per 10 minutes.
severity: Medium
tactics:
  - Impact
queryFrequency: PT5M
queryPeriod: PT1H
triggerOperator: GreaterThan
triggerThreshold: 0
query: |
  CyberArk_AuditEvents_CL
  | extend cd = parse_json(customData)
  | extend cd_target = coalesce(tostring(cd.target), tostring(cd.target_resource), tostring(cd.new_target))
  | where TimeGenerated > ago(1h)
  | summarize cnt=count(), targets=make_set(target, 10), cd_targets=make_set(cd_target, 10), actions=make_set(action, 10) by bin(TimeGenerated, 10m), username
  | where cnt >= 50
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: username
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: target
suppressionEnabled: false
version: 1.0.0
