kind: Scheduled
name: CyberArk - High-Risk Actions Outside Business Hours
description: >
  Detects privileged or destructive actions (delete/disable/rotate/elevate/etc.)
  occurring outside standard business hours. Useful for insider misuse or
  compromised admin detection.
severity: High
tactics:
  - DefenseEvasion
queryFrequency: PT10M
queryPeriod: P1D
triggerOperator: GreaterThan
triggerThreshold: 0
query: |
  let risky = dynamic(["Delete","Remove","Rotate","Elevate","Disable","Grant","Policy","Safe","Vault","Key"]);
  CyberArk_AuditEvents_CL
  | extend EventTime = datetime(1970-01-01) + tolong(timestamp)*1s
  | where isnotempty(action) or isnotempty(actionType) or isnotempty(auditType) or isnotempty(message)
  | where hourofday(EventTime) < 7 or hourofday(EventTime) > 20
  | where action has_any (risky)
      or actionType has_any (risky)
      or auditType has_any (risky)
      or message has_any (risky)
  | project EventTime, CyberArkTenantId, username, identityType, action, actionType, auditType, target, targetAccount, safe, source, component, message
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: username
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: target
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: source
suppressionEnabled: false
version: 1.0.0
