kind: Scheduled
name: CyberArk - New Access Method for User
description: >
  Flags a user employing a new accessMethod (e.g., typically PSM, now API/RDP/SSH).
  Baselines the last 30 days and alerts on deviations in the last day.
severity: Medium
tactics:
  - InitialAccess
  - LateralMovement
queryFrequency: PT15M
queryPeriod: P31D
triggerOperator: GreaterThan
triggerThreshold: 0
query: |
  let lookback = 30d;
  let eval = 1d;
  let baseline =
      CyberArk_AuditEvents_CL
      | extend EventTime = datetime(1970-01-01) + tolong(timestamp)*1s
      | where EventTime between (ago(lookback) .. ago(eval))
      | where isnotempty(accessMethod)
      | summarize by username, accessMethod;
  CyberArk_AuditEvents_CL
  | extend EventTime = datetime(1970-01-01) + tolong(timestamp)*1s
  | where EventTime > ago(eval)
  | where isnotempty(accessMethod)
  | join kind=leftanti baseline on username, accessMethod
  | project EventTime, CyberArkTenantId, username, identityType, accessMethod, action, target, safe, source, message
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: username
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: target
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: source
suppressionEnabled: false
version: 1.0.1
