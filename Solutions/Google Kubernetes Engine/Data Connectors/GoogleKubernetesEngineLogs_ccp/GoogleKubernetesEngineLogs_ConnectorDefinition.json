{
    "name": "GKECCPDefinition",
    "apiVersion": "2024-09-01",
    "type": "Microsoft.SecurityInsights/dataConnectorDefinitions",
    "location": "{{location}}",
    "kind": "Customizable",
    "properties": {
        "connectorUiConfig": {
            "id": "GKECCPDefinition",
            "title": "Google Kubernetes Engine",
            "publisher": "Microsoft",
            "descriptionMarkdown": "The Google Kubernetes Engine (GKE) Logs enable you to capture cluster activity, workload behavior, and security events, allowing you to monitor Kubernetes workloads, analyze performance, and detect potential threats across GKE clusters.",
            "graphQueriesTableName": "GKEAuditLogs_CL",
            "graphQueries": [
                {
                    "metricName": "Total events received",
                    "legend": "GKEAuditLogs",
                    "baseQuery": "GKEAuditLogs_CL"
                },
                {
                    "metricName": "Total API Server logs received",
                    "legend": "GKEAPIServerLogs",
                    "baseQuery": "GKEAPIServerLogs_CL"
                },
                {
                    "metricName": "Total Scheduler logs received",
                    "legend": "GKESchedulerLogs",
                    "baseQuery": "GKESchedulerLogs_CL"
                },
                {
                    "metricName": "Total Controller Manager logs received",
                    "legend": "GKEControllerManagerLogs",
                    "baseQuery": "GKEControllerManagerLogs_CL"
                },
                {
                    "metricName": "Total HPA Decision logs received",
                    "legend": "GKEHPADecisionLogs",
                    "baseQuery": "GKEHPADecisionLogs_CL"
                },
                {
                    "metricName": "Total Application logs received",
                    "legend": "GKEApplicationLogs",
                    "baseQuery": "GKEApplicationLogs_CL"
                }
            ],
            "sampleQueries": [
                {
                    "description": "Get Sample of GKE Logs",
                    "query": "GKEAuditLogs_CL\n | take 10"
                },
                {
                    "description": "Get Sample of GKE API Server Logs",
                    "query": "GKEAPIServerLogs_CL\n | take 10"
                },
                {
                    "description": "Get Sample of GKE Scheduler Logs",
                    "query": "GKESchedulerLogs_CL\n | take 10"
                },
                {
                    "description": "Get Sample of GKE Controller Manager Logs",
                    "query": "GKEControllerManagerLogs_CL\n | take 10"
                },
                {
                    "description": "Get Sample of GKE HPA Decision Logs",
                    "query": "GKEHPADecisionLogs_CL\n | take 10"
                },
                {
                    "description": "Get Sample of GKE Application Logs",
                    "query": "GKEApplicationLogs_CL\n | take 10"
                }
            ],
            "dataTypes": [
                {
                    "name": "GKEAuditLogs_CL",
                    "lastDataReceivedQuery": "GKEAuditLogs_CL\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                },
                {
                    "name": "GKEAPIServerLogs_CL",
                    "lastDataReceivedQuery": "GKEAPIServerLogs_CL\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                },
                {
                    "name": "GKESchedulerLogs_CL",
                    "lastDataReceivedQuery": "GKESchedulerLogs_CL\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                },
                {
                    "name": "GKEControllerManagerLogs_CL",
                    "lastDataReceivedQuery": "GKEControllerManagerLogs_CL\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                },
                {
                    "name": "GKEHPADecisionLogs_CL",
                    "lastDataReceivedQuery": "GKEHPADecisionLogs_CL\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                },
                {
                    "name": "GKEApplicationLogs_CL",
                    "lastDataReceivedQuery": "GKEApplicationLogs_CL\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                }
            ],
            "availability": {
                "status": 1,
                "isPreview": false
            },
            "connectivityCriteria": [
                {
                    "type": "HasDataConnectors"
                }
            ],
            "permissions": {
                "resourceProvider": [
                    {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                            "read": true,
                            "write": true,
                            "delete": true,
                            "action": false
                        }
                    }
                ]
            },
            "instructionSteps": [
                    {
                    "instructions": [
                        {
                            "type": "MarkdownControlEnvBased",
                            "parameters": {
                                "prodScript": "#### 1. Set up your GCP environment \n You must have the following GCP resources defined and configured: topic, subscription for the topic, workload identity pool, workload identity provider, and service account with permissions to get and consume from the subscription. \n To configure this data connector, execute the following Terraform scripts:\n 1. Setup Required Resources: [Configuration Guide](https://github.com/Alekhya0824/GithubValidationREPO/blob/main/gke/Readme.md)\n 2. Setup Authentication: [Authentication tutorial](https://learn.microsoft.com/en-us/azure/sentinel/connect-google-cloud-platform?tabs=terraform%2Cauditlogs#gcp-authentication-setup).",
                                "govScript": "#### 1. Set up your GCP environment \n You must have the following GCP resources defined and configured: topic, subscription for the topic, workload identity pool, workload identity provider, and service account with permissions to get and consume from the subscription. \n To configure this data connector, execute the following Terraform scripts:\n 1. Setup Required Resources: [Configuration Guide](https://github.com/Alekhya0824/GithubValidationREPO/blob/main/gke/Readme.md)\n 2. Setup Authentication: [Authentication tutorial](https://learn.microsoft.com/en-us/azure/sentinel/connect-google-cloud-platform?tabs=terraform%2Cauditlogs#gcp-authentication-setup)."
                            }
                        },
                        {
                        "type": "CopyableLabel",
                        "parameters": {
                            "label": "Tenant ID: A unique identifier that is used as an input in the Terraform configuration within a GCP environment.",
                            "fillWith": [
                            "TenantId"
                            ],
                            "name": "TenantId",
                            "disabled": true
                        }
                        },
                        {
                            "type": "Markdown",
                            "parameters": {
                            "content": "#### 2. Enable Kubernetes Engine Logging \nIn your GCP account, navigate to the Kubernetes Engine section. Enable Cloud Logging for your clusters. Within Cloud Logging, ensure that the specific logs you want to ingest—such as API server, scheduler, controller manager, HPA decision, and application logs—are enabled for effective monitoring and security analysis."
                            }
                        },                          
                        {
                        "type": "Markdown",
                        "parameters": {
                            "content": "#### 3. Connect new collectors \n To enable GKE Logs for Microsoft Sentinel, click the Add new collector button, fill in the required information in the context pane, and click Connect."
                        }
                        },
                        {
                        "type": "GCPGrid",
                        "parameters": {}
                        },
                        {
                        "type": "GCPContextPane",
                        "parameters": {}
                        }
                    ]
                    }
                ]
        }
    }
}
