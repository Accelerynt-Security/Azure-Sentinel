{
    "version": "Notebook/1.0",
    "items": [
      {
        "type": 1,
        "content": {
          "json": "## Severity Breakdown"
        },
        "name": "text - 4"
      },
      {
        "type": 1,
        "content": {
          "json": "## Attack Path Overview"
        },
        "name": "text - 2"
      },
      {
        "type": 9,
        "content": {
          "version": "KqlParameterItem/1.0",
          "parameters": [
            {
              "id": "6de26de7-0eec-4312-b568-9fbbaf5c7f71",
              "version": "KqlParameterItem/1.0",
              "name": "bhe_tenant",
              "label": "BHE Tenant",
              "type": 2,
              "isRequired": true,
              "query": "BloodHoundAttackPathsDetails_CL \n| where isnotempty(tenant_url)\n| summarize arg_max(TimeGenerated, *) by tenant_url\n| extend display_name = replace_string(tenant_url, @\"https://\", \"\")\n| extend display_name = replace_string(display_name, @\"http://\", \"\")\n| extend display_name = replace_string(display_name, @\"/\", \"\") \n| project tenant_url, display_name",
              "typeSettings": {
                "additionalResourceOptions": [
                  "value::1"
                ]
              },
              "timeContext": {
                "durationMs": 86400000
              },
              "defaultValue": "value::1",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            {
              "id": "cb118fcd-4473-4470-ac89-28c6ea644d5d",
              "version": "KqlParameterItem/1.0",
              "name": "domain_name",
              "label": "Domain",
              "type": 2,
              "isRequired": true,
              "multiSelect": true,
              "quote": "'",
              "delimiter": ",",
              "query": "BloodHoundAttackPathsDetails_CL \n| where isnotempty(domain_name)\n| where tenant_url == '{bhe_tenant}'\n| distinct domain_name",
              "typeSettings": {
                "additionalResourceOptions": [
                  "value::all"
                ],
                "showDefault": false
              },
              "timeContext": {
                "durationMs": 86400000
              },
              "defaultValue": "value::all",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            }
          ],
          "style": "pills",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces"
        },
        "name": "parameters - 2"
      },
      {
        "type": 1,
        "content": {
          "json": "## Total Attack Paths Findings per Domain"
        },
        "name": "text - 3"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "BloodHoundAttackPathsDetails_CL\n| where tenant_url == '{bhe_tenant}'\n| where domain_name in~ ({domain_name})\n| summarize TotalAttackPathsFindings = dcount(id) by DomainName = domain_name\n| sort by TotalAttackPathsFindings desc",
          "size": 1,
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "barchart"
        },
        "name": "query - 2"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "BloodHoundAttackPathsDetails_CL\n| where tenant_url == '{bhe_tenant}'\n| where domain_name in~ ({domain_name})\n| summarize Count = dcount(id) by Severity\n| sort by Count desc\n",
          "size": 0,
          "timeContext": {
            "durationMs": 86400000
          },
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "piechart"
        },
        "name": "query - 5"
      },
      {
        "type": 1,
        "content": {
          "json": "## Top 5 Non-Tier Zero Principals Involved in Findings"
        },
        "name": "text - 6"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "BloodHoundAttackPathsDetails_CL\n| where tenant_url == '{bhe_tenant}'\n| where domain_name in~ ({domain_name})\n| where isnull(ImpactedPrincipalProps.system_tags) or ImpactedPrincipalProps.system_tags != \"admin_tier_0\"\n| summarize FindingsCount = dcount(id) by NonTierZeroPrincipal\n| sort by FindingsCount desc\n| take 5",
          "size": 0,
          "timeContext": {
            "durationMs": 259200000
          },
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "unstackedbar",
          "chartSettings": {
            "xAxis": "FindingsCount",
            "yAxis": [
              "FindingsCount"
            ]
          }
        },
        "name": "query - 7"
      },
      {
        "type": 1,
        "content": {
          "json": "## Top 5 Most Common Findings"
        },
        "name": "text - 8"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "BloodHoundAttackPathsDetails_CL\n| where tenant_url == '{bhe_tenant}'\n| where domain_name in~ ({domain_name})\n| summarize Occurrence = dcount(id) by Finding\n| sort by Occurrence desc\n| take 5\n",
          "size": 0,
          "timeContext": {
            "durationMs": 86400000
          },
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "barchart"
        },
        "name": "query - 9"
      },
      {
        "type": 1,
        "content": {
          "json": "## All Attack Paths"
        },
        "name": "text - 10"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "BloodHoundAttackPathsDetails_CL\n| where tenant_url == '{bhe_tenant}'\n| where domain_name in~ ({domain_name})\n| extend exposure_pct = iif(isnull(ExposurePercentage), round(ImpactPercentage * 100, 2), round(ExposurePercentage * 100, 2))\n| extend impact_pct = round(ImpactPercentage * 100, 2)\n| summarize \n    ExposurePercent = max(exposure_pct),\n    ImpactPercent = max(impact_pct),\n    Remediation = any(Remediation),  \n    Count = count()\n    by Domain = domain_name, AttackPath = PathTitle, Severity\n| project Domain, AttackPath, Severity, Count, ['Exposure (%)'] = ExposurePercent, ['Impact (%)'] = ImpactPercent, Remediation\n| sort by ['Exposure (%)'] desc\n",
          "size": 0,
          "timeContext": {
            "durationMs": 86400000
          },
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "sortBy": [
              {
                "itemKey": "Exposure (%)",
                "sortOrder": 1
              }
            ]
          },
          "sortBy": [
            {
              "itemKey": "Exposure (%)",
              "sortOrder": 1
            }
          ]
        },
        "name": "query - 11"
      }
    ],
    "fallbackResourceIds": [
      "/subscriptions/8487150a-2b54-4945-9a15-7aae2d005a3d/resourcegroups/specterops/providers/microsoft.operationalinsights/workspaces/specterops-log-analytics-workspace"
    ],
    "fromTemplateId": "sentinel-UserWorkbook",
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
  }
